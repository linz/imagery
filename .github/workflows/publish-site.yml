name: Publish Site
on:
  push:
      branches:
        - master
      paths:
        - 'README.md'
        - 'site/**'
        - '!site/update.sh'
        - '!site/site.md'

jobs:
  main:
    name: Publish Site
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: linz/action-typescript@v3

      - name: AWS Configure
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-region: ap-southeast-2
          mask-aws-account-id: true
          role-to-assume: ${{ secrets.AWS_CI_ROLE }}

      - name: AWS Configure ODR
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-region: ap-southeast-2
          mask-aws-account-id: true
          role-to-assume: ${{ secrets.AWS_ODR_DATAMANAGER_ROLE }}
          role-chaining: true

      - name: Deploy page to S3
        run: |
          node site/generate.site.mjs
          aws s3 cp index.html s3://nz-imagery/index.html